# üî∑ **Azure Static Web App Architecture Template: LogoCraft Web**

---

### üìå 1. **Project Overview**

| Item                | Description |
| ------------------- | ----------- |
| App Name            | LogoCraft Web |
| Purpose / Use Case  | A web application for converting and processing logo images into multiple formats with specific dimensions. Allows users to upload images and convert them to various standardized logo formats including installer images, online images, app icons, and UI elements. |
| Resource Group Name | LogoCraftRG |
| Azure Region        | East US |

---

### üóÇÔ∏è 2. **Resource Flow Diagram**

```text
Browser/Client
   ‚Üì
[Azure Static Web App (logocraft-frontend)]
   ‚Üì                                ‚Üò
[API via Azure Functions (logocraftfunctions - integrated with SWA)]  ‚Üí  [Blob Storage (logocraftstorage)]
   |                                                                         ‚Üë (uploads container)
   ‚Üì                                                                         | (downloads container)
[Single Function: ProcessImageAndSas] 
  (Action: getUploadSas) ‚Üí Returns SAS URL to client for direct upload to 'uploads' container
  (Action: processImage) ‚Üí Reads from 'uploads', processes, writes to 'downloads' container
   ‚Üì
[Return processed image URLs (from 'downloads' container) to client for download]
   ‚Üì
[Client downloads images and creates ZIP file for user]
```

---

### üîê 3. **Authentication & Authorization**

| Component             | Method                                                    | Notes |
| --------------------- | --------------------------------------------------------- | ----- |
| Static Web App        | None (Public access)                                      | No user authentication required. |
| Azure Functions (API) | Anonymous HTTP Triggers                                   | Public API endpoints; part of SWA. |
| Blob Storage          | Function-Generated SAS Tokens (via Connection String)     | Function uses storage connection string to generate SAS for 'uploads'. 'downloads' is public. |

> **Checklist:**

* ‚òë SWA Auth Providers configured - N/A (public access)
* ‚òê Role-based access rules set in `staticwebapp.config.json` - N/A (public access)
* ‚òë CORS rules defined for Blob + Functions (SWA manages Function CORS, Blob CORS for direct uploads)
* ‚òë Blob access: `uploads` (Private with SAS), `downloads` (Public Blob)
* ‚òê RBAC roles assigned - N/A for connection string SAS (relevant if/when re-introducing Managed Identity)

---

### üß† 4. **Environment Variables / App Settings (Static Web App)**

| Setting Name                            | Example Value / Notes                                     | Scope    |
| --------------------------------------- | --------------------------------------------------------- | -------- |
| `AZURE_STORAGE_CONNECTION_STRING`       | `DefaultEndpointsProtocol=https;AccountName=...;AccountKey=...` | SWA App Settings (for integrated Function) |
| `AzureWebJobsStorage`                   | (Can often be same as `AZURE_STORAGE_CONNECTION_STRING` for SWA managed functions or managed by SWA) | SWA App Settings |
| `APPLICATIONINSIGHTS_CONNECTION_STRING` | `InstrumentationKey=...`                                  | SWA App Settings |

> **Checklist:**

* ‚òë Environment secrets (like `AZURE_STORAGE_CONNECTION_STRING`) configured in SWA Application Settings.
* ‚òë `AzureWebJobsStorage` configured for SWA managed functions.

---

### üîÑ 5. **Azure Blob Storage Configuration**

| Setting                  | Value / Notes |
| ------------------------ | ------------- |
| Access Level             | `uploads` (Private), `downloads` (Blob - Public Read) |
| Containers               | `uploads`, `downloads` |
| CORS Rules               | Allow SWA origin for direct uploads to `uploads` container. |
| Lifecycle Rules (if any) | None specified |
| SAS Tokens Used?         | ‚òë Yes (for `uploads` container, generated by function) ‚òê No    |
| Managed Identity Access? | ‚òê Yes ‚òë No (Using connection string for this version)   |
| SAS Token Expiry         | 1-hour validity period (for upload SAS) |

---

### ‚öôÔ∏è 6. **Function App (API) Details (Integrated with SWA)**

| Item                  | Value / Notes                |
| --------------------- | ---------------------------- |
| Runtime Stack         | Node.js 18+                  |
| Authorization Level   | Anonymous                    |
| Route Prefix          | api                          |
| CORS Enabled?         | ‚òë Yes (Managed by SWA or function code if needed) |
| Blob Access Mechanism | Azure SDK (`@azure/storage-blob`) with Storage Account Connection String. |
| Dependencies          | sharp, node-fetch, @azure/storage-blob |

> **API Endpoints (Single Function e.g., `/api/ProcessImage`):**
- **GET** `?action=getUploadSas&filename=<filename>`
  - **Purpose**: Generates SAS token for client-side upload to `uploads` container.
  - **Response**: `{ uploadUrl: string, blobName: string }`
- **POST** `?action=processImage`
  - **Purpose**: Processes an image previously uploaded to the `uploads` container.
  - **Body**: `{ sourceBlobName: string, formats: object }`
  - **Response**: `{ processedImages: Array<{ name: string, url: string, size: string, dimensions: object }> }` (URLs are direct public links to `downloads` container).

---

### üîÅ 7. **GitHub Workflow / CI-CD**

| Stage      | Configured? | Notes |
| ---------- | ----------- | ----- |
| Build      | ‚òë           | Frontend build with npm run build |
| Test       | ‚òê           | Not implemented |
| Deploy SWA | ‚òë           | Azure Static Web Apps deploy action |
| Deploy API | ‚òë           | Included in SWA deployment |

> **Checklist:**

* ‚òë `.github/workflows/web-app-deploy.yml` (or similar SWA workflow file) present and configured.
* ‚òë SWA Deployment token (`AZURE_STATIC_WEB_APPS_API_TOKEN`) configured in GitHub secrets.
* ‚òë Branch filters (e.g., main branch triggers production deployment).

---

### üåê 8. **CORS Configuration**

| Resource        | Origins Allowed | Notes              |
| --------------- | --------------- | ------------------ |
| Static Web App  | *               | Public access      |
| Azure Functions | SWA URL, localhost:3000 | Required for API calls during development and production |
| Blob Storage    | SWA URL, localhost:3000 | Required for direct uploads during development and production |

---

### üß™ 9. **Environments & Deployment Slots (Optional)**

| Environment | SWA Environment Name | Branch  | Notes          |
| ----------- | -------------------- | ------- | -------------- |
| Production  | Production           | main    |                |
| Preview     | Staging              | PR      | Auto-generated for PRs |

---

### ‚úÖ 10. **Final Checklist**

| Area                            | Completed? | Notes |
| ------------------------------- | ---------- | ----- |
| Auth setup (SAS via conn string)| ‚òë          | Simplified for initial deployment. |
| Blob storage configured         | ‚òë          | `uploads` (private), `downloads` (public). |
| API (single function) tested    | ‚òê          | Pending deployment and testing. |
| Environment vars injected (SWA) | ‚òê          | To be verified upon deployment. |
| GitHub Actions pipeline working | ‚òë          | Workflows updated for SWA. |
| CORS configured                 | ‚òë          | SWA default, Blob for uploads. |
| Secrets secured (GH & SWA)      | ‚òê          | Requires `AZURE_STATIC_WEB_APPS_API_TOKEN` and `AZURE_STORAGE_CONNECTION_STRING` in SWA settings. |
| Custom domain setup             | ‚òê          | Future consideration. |
| RBAC roles assigned             | N/A        | Not primary for conn string SAS. |
| Local development tested        | ‚òê          | Pending full local test with SWA CLI or similar. |

---

### üìã **Key Implementation Notes:**

1.  **Authentication Model (Simplified):**
    *   The integrated Azure Function uses an Azure Storage Account connection string (from SWA app settings) to generate SAS tokens for client uploads to the `uploads` container.
    *   This approach defers Managed Identity for initial simplicity.

2.  **Storage Access & Containers:**
    *   `uploads` container: Private, written to by clients using function-generated SAS tokens.
    *   `downloads` container: Public read access for blobs, allowing direct URL access to processed images.
    *   The function reads from `uploads` and writes to `downloads` using its connection string.

3.  **Image Processing Flow (Simplified API):**
    *   Client requests an upload SAS URL from the single Azure Function (`/api/ProcessImage?action=getUploadSas`).
    *   Client uploads the image directly to the `uploads` container using the SAS URL.
    *   Client requests image processing from the same Azure Function (`/api/ProcessImage?action=processImage`), providing the `sourceBlobName`.
    *   Function processes the image and returns an array of public URLs for the processed images in the `downloads` container.
    *   Client downloads/uses these public URLs.

4.  **Supported Image Formats**:
   - Input: PNG, JPEG, GIF, BMP, TIFF, WebP
   - Output: 
     - PNG formats with configurable dimensions
     - 1-bit monochrome BMP for specialized use cases like thermal printers
     - Support for over 25 different output formats including app icons, splash screens, and UI elements

5. **Error Handling**:
   - Comprehensive error handling in both Azure Functions
   - Detailed error messages with appropriate HTTP status codes
   - Client-side validation and error reporting
   - Fallback mechanisms for authentication methods

6. **Local Development Support**:
   - Local settings with storage account key for development
   - CORS configuration allows localhost during development
   - Azure Functions Core Tools for local function execution
   - Vite development server with API proxy
